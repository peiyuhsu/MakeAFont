<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å­—åœ–æ ¡å°å·¥å…· V8ï¼ˆå¢å¼·ç‰ˆï¼‰</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 20px;
    }
    .cell {
      text-align: center;
      border: 1px solid #eee;
      padding: 10px;
      border-radius: 5px;
      position: relative;
    }
    .cell:hover {
      border-color: #aaa;
      background-color: #f9f9f9;
    }
    .cell img {
      width: 100%;
      border: 1px solid #ddd;
      background-color: #fff;
    }
    .cell .input-group {
      margin-top: 5px;
      display: flex;
      flex-direction: column;
    }
    .cell input {
      width: 90%;
      text-align: center;
      padding: 4px;
      margin: 2px auto;
    }
    .cell .unicode-info {
      font-size: 0.8em;
      color: #666;
      margin-top: 3px;
    }
    .controls {
      margin-bottom: 20px;
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .status {
      margin-top: 10px;
      font-weight: bold;
    }
    .button-group {
      margin: 10px 0;
    }
    button {
      padding: 5px 10px;
      margin-right: 5px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    .search-box {
      margin: 10px 0;
      width: 300px;
      padding: 5px;
    }
    .pagination {
      margin: 10px 0;
      text-align: center;
    }
    .pagination button {
      background-color: #ddd;
      color: black;
    }
    .pagination button.active {
      background-color: #4CAF50;
      color: white;
    }
    .invalid-input {
      border-color: #ff6b6b !important;
      background-color: #ffeeee !important;
    }
    .auto-guess-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 0.7em;
      padding: 2px 5px;
      background-color: #f0f0f0;
      color: #333;
      border: 1px solid #ccc;
      border-radius: 3px;
      cursor: pointer;
    }
    .auto-guess-btn:hover {
      background-color: #e0e0e0;
    }
    .zoom-controls {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div class="controls">
    <div>
      <input type="file" id="imgFolder" webkitdirectory directory />
      <span id="fileCount"></span>
    </div>
    <div class="button-group">
      <input type="file" id="charListFile" />
      <button onclick="fillFromList()">å¡«å…¥å…¨éƒ¨å­—å…ƒ</button>
      <button onclick="autoGuessByFilename()">æ ¹æ“šæª”åè‡ªå‹•å¡«å…¥</button>
      <button onclick="exportJson()">åŒ¯å‡º JSON</button>
      <button onclick="saveProgress()">æš«å­˜é€²åº¦</button>
      <button onclick="loadProgress()">è¼‰å…¥é€²åº¦</button>
    </div>
    <div>
      <input type="text" id="searchBox" class="search-box" placeholder="æœå°‹æª”åæˆ–å­—å…ƒ..." oninput="filterGrid()" />
      <div class="zoom-controls">
        ç¸®æ”¾: <input type="range" id="zoomSlider" min="50" max="200" value="100" oninput="adjustZoom(this.value)" />
        <span id="zoomValue">100%</span>
      </div>
    </div>
    <div class="pagination" id="pagination"></div>
    <div class="status" id="statusMessage"></div>
  </div>

  <div class="grid" id="previewGrid"></div>

  <script>
    let images = [];
    let allCells = [];
    const ITEMS_PER_PAGE = 100;
    let currentPage = 1;
    let filteredImages = [];
    
    document.getElementById("imgFolder").addEventListener("change", function(e) {
      images = Array.from(e.target.files).filter(file => file.name.toLowerCase().endsWith(".png"));
      images.sort((a, b) => {
        // å˜—è©¦å¾æª”åæå–æ•¸å­—é€²è¡Œæ’åº
        const numA = parseInt(a.name.replace(/\D/g, "")) || 0;
        const numB = parseInt(b.name.replace(/\D/g, "")) || 0;
        return numA - numB || a.name.localeCompare(b.name);
      });
      
      document.getElementById("fileCount").textContent = `ï¼ˆå·²é¸æ“‡ ${images.length} å€‹PNGæª”ï¼‰`;
      filteredImages = [...images];
      renderPagination();
      renderPage(1);
    });

    function renderPagination() {
      const totalPages = Math.ceil(filteredImages.length / ITEMS_PER_PAGE);
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      
      if (totalPages <= 1) return;
      
      // ä¸Šä¸€é æŒ‰éˆ•
      const prevBtn = document.createElement("button");
      prevBtn.textContent = "ä¸Šä¸€é ";
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => {
        if (currentPage > 1) renderPage(currentPage - 1);
      };
      pagination.appendChild(prevBtn);
      
      // é ç¢¼æŒ‰éˆ•
      const maxButtons = 7;
      let startPage = Math.max(1, currentPage - Math.floor(maxButtons/2));
      let endPage = Math.min(totalPages, startPage + maxButtons - 1);
      
      if (endPage - startPage + 1 < maxButtons) {
        startPage = Math.max(1, endPage - maxButtons + 1);
      }
      
      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement("button");
        pageBtn.textContent = i;
        pageBtn.className = i === currentPage ? "active" : "";
        pageBtn.onclick = () => renderPage(i);
        pagination.appendChild(pageBtn);
      }
      
      // ä¸‹ä¸€é æŒ‰éˆ•
      const nextBtn = document.createElement("button");
      nextBtn.textContent = "ä¸‹ä¸€é ";
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = () => {
        if (currentPage < totalPages) renderPage(currentPage + 1);
      };
      pagination.appendChild(nextBtn);
      
      // é¡¯ç¤ºé æ•¸è³‡è¨Š
      const pageInfo = document.createElement("span");
      pageInfo.textContent = ` ${currentPage}/${totalPages} é `;
      pageInfo.style.marginLeft = "10px";
      pagination.appendChild(pageInfo);
    }

    function renderPage(pageNum) {
      currentPage = pageNum;
      const grid = document.getElementById("previewGrid");
      grid.innerHTML = "";
      allCells = [];
      
      const start = (pageNum - 1) * ITEMS_PER_PAGE;
      const end = Math.min(start + ITEMS_PER_PAGE, filteredImages.length);
      
      for (let i = start; i < end; i++) {
        const file = filteredImages[i];
        const cell = createCell(file);
        grid.appendChild(cell);
        allCells.push(cell);
      }
      
      renderPagination();
      document.getElementById("statusMessage").textContent = `ğŸ“¦ åœ–ç‰‡ç¸½æ•¸ï¼š${images.length}ï¼Œç•¶å‰é¡¯ç¤ºï¼š${start + 1} - ${end}`;
    }

    function createCell(file) {
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.filename = file.name;
      
      const img = document.createElement("img");
      img.src = URL.createObjectURL(file);
      img.title = file.name;
      
      const guessBtn = document.createElement("button");
      guessBtn.className = "auto-guess-btn";
      guessBtn.textContent = "çŒœ";
      guessBtn.title = "æ ¹æ“šæª”åçŒœæ¸¬å­—å…ƒ";
      guessBtn.onclick = (e) => {
        e.stopPropagation();
        autoGuessSingle(cell, file.name);
      };
      
      const inputGroup = document.createElement("div");
      inputGroup.className = "input-group";
      
      const input = document.createElement("input");
      input.type = "text";
      input.maxLength = 1;
      input.placeholder = "è¼¸å…¥å­—å…ƒ";
      input.dataset.index = file.name.replace(/\.(png|jpg|jpeg|gif)$/i, "");
      input.dataset.filename = file.name;
      input.addEventListener("input", function() {
        validateAndUpdateInfo(this);
      });
      
      const unicodeInfo = document.createElement("div");
      unicodeInfo.className = "unicode-info";
      
      inputGroup.appendChild(input);
      inputGroup.appendChild(unicodeInfo);
      
      cell.appendChild(img);
      cell.appendChild(guessBtn);
      cell.appendChild(inputGroup);
      
      return cell;
    }

    function validateAndUpdateInfo(input) {
      const unicodeInfo = input.parentElement.querySelector(".unicode-info");
      const char = input.value.trim();
      
      if (!char) {
        unicodeInfo.textContent = "";
        input.classList.remove("invalid-input");
        return;
      }
      
      if (!isValidChar(char)) {
        unicodeInfo.textContent = "âš ï¸ éä¸­æ—¥éŸ“æ–‡å­—";
        unicodeInfo.style.color = "#ff6b6b";
        input.classList.add("invalid-input");
      } else {
        const codePoint = char.codePointAt(0);
        unicodeInfo.textContent = `U+${codePoint.toString(16).toUpperCase()}`;
        unicodeInfo.style.color = "#666";
        input.classList.remove("invalid-input");
      }
    }

    function isValidChar(ch) {
      if (typeof ch !== "string" || ch.length === 0) return false;
      
      const code = ch.codePointAt(0);
      // ä¸­æ—¥éŸ“çµ±ä¸€è¡¨æ„æ–‡å­—åŸºæœ¬å€ (CJK Unified Ideographs)
      if (code >= 0x4E00 && code <= 0x9FFF) return true;
      // ä¸­æ—¥éŸ“çµ±ä¸€è¡¨æ„æ–‡å­—æ“´å……å€ A (CJK Unified Ideographs Extension A)
      if (code >= 0x3400 && code <= 0x4DBF) return true;
      // ä¸­æ—¥éŸ“çµ±ä¸€è¡¨æ„æ–‡å­—æ“´å……å€ B-F
      if (code >= 0x20000 && code <= 0x2FA1F) return true;
      // å…¶ä»–å¸¸ç”¨ä¸­æ—¥éŸ“å€å¡Š
      if (code >= 0x2E80 && code <= 0x2EFF) return true; // CJK éƒ¨é¦–è£œå……
      if (code >= 0x2F00 && code <= 0x2FDF) return true; // åº·ç†™éƒ¨é¦–
      if (code >= 0x3000 && code <= 0x303F) return true; // CJK ç¬¦è™Ÿå’Œæ¨™é»
      if (code >= 0x3100 && code <= 0x312F) return true; // æ³¨éŸ³ç¬¦è™Ÿ
      if (code >= 0x31A0 && code <= 0x31BF) return true; // æ³¨éŸ³ç¬¦è™Ÿæ“´å……
      if (code >= 0x31C0 && code <= 0x31EF) return true; // CJK ç­†ç•«
      
      return false;
    }

    function fillFromList() {
      const fileInput = document.getElementById("charListFile");
      const file = fileInput.files[0];
      if (!file) {
        alert("è«‹é¸æ“‡å­—å…ƒåˆ—è¡¨æª”æ¡ˆï¼");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const lines = e.target.result.split(/\r?\n/).filter(Boolean);
        const chars = lines.map(line => {
          line = line.trim();
          
          // è™•ç†å¤šç¨®æ ¼å¼
          if (line.startsWith("uni") && line.length >= 7) {
            try {
              return String.fromCodePoint(parseInt(line.slice(3), 16));
            } catch {
              return "";
            }
          } else if (line.startsWith("U+") && line.length >= 3) {
            try {
              return String.fromCodePoint(parseInt(line.slice(2), 16));
            } catch {
              return "";
            }
          } else if (line.length === 1) {
            // ç›´æ¥æ˜¯å–®å€‹å­—å…ƒ
            return line;
          }
          return "";
        });

        if (chars.filter(Boolean).length === 0) {
          alert("âš ï¸ ç„¡æ³•è§£æå­—å…ƒåˆ—è¡¨ï¼Œè«‹ç¢ºèªæ ¼å¼æ­£ç¢ºï¼");
          return;
        }
        
        if (chars.length !== images.length) {
          alert(`âš ï¸ å­—å…ƒæ•¸ (${chars.length}) èˆ‡åœ–ç‰‡æ•¸ (${images.length}) ä¸ä¸€è‡´ï¼\nç¹¼çºŒå°‡æŒ‰é †åºå¡«å…¥å¯ç”¨å­—å…ƒã€‚`);
        }

        const inputs = document.querySelectorAll("input[data-index]");
        let filledCount = 0;
        
        inputs.forEach((input, i) => {
          if (i < chars.length) {
            const ch = chars[i];
            if (ch) {
              input.value = ch;
              validateAndUpdateInfo(input);
              filledCount++;
            }
          }
        });

        document.getElementById("statusMessage").textContent = `âœ… å·²å¡«å…¥ ${filledCount} å€‹å­—å…ƒ`;
      };
      reader.readAsText(file, "utf-8");
    }

    function autoGuessByFilename() {
      let guessedCount = 0;
      const inputs = document.querySelectorAll("input[data-index]");
      
      inputs.forEach(input => {
        const filename = input.dataset.filename;
        if (autoGuessSingle(input.closest(".cell"), filename)) {
          guessedCount++;
        }
      });
      
      document.getElementById("statusMessage").textContent = `ğŸ”„ å·²è‡ªå‹•çŒœæ¸¬ ${guessedCount} å€‹å­—å…ƒ`;
    }

    function autoGuessSingle(cell, filename) {
      const input = cell.querySelector("input");
      if (input.value) return false; // å·²æœ‰å€¼å°±ä¸è¦†è“‹
      
      let char = "";
      
      // è™•ç†ã€ŒuniXXXX.pngã€æ ¼å¼
      const uniMatch = filename.match(/uni([0-9A-Fa-f]{4,6})\.png$/i);
      if (uniMatch) {
        try {
          char = String.fromCodePoint(parseInt(uniMatch[1], 16));
        } catch {}
      }
      
      // è™•ç†ã€ŒU+XXXX.pngã€æ ¼å¼
      const uPlusMatch = filename.match(/U\+([0-9A-Fa-f]{4,6})\.png$/i);
      if (uPlusMatch) {
        try {
          char = String.fromCodePoint(parseInt(uPlusMatch[1], 16));
        } catch {}
      }
      
      // è™•ç†ã€Œå­—å…ƒ.pngã€æ ¼å¼ï¼Œå‡è¨­æª”åå°±æ˜¯å–®å€‹å­—å…ƒ
      if (!char && filename.length >= 2 && filename.endsWith(".png")) {
        const possibleChar = filename.slice(0, -4);
        if (possibleChar.length === 1 && isValidChar(possibleChar)) {
          char = possibleChar;
        }
      }
      
      if (char && isValidChar(char)) {
        input.value = char;
        validateAndUpdateInfo(input);
        return true;
      }
      
      return false;
    }

    function exportJson() {
      const inputs = document.querySelectorAll("input[data-index]");
      const data = [];
      const seen = new Set();
      const duplicates = [];
      const missing = [];

      inputs.forEach(input => {
        const char = input.value.trim();
        const index = input.dataset.index;
        const filename = input.dataset.filename;
        
        if (char) {
          if (seen.has(char)) {
            duplicates.push(`${char} (${filename})`);
          } else {
            seen.add(char);
          }
          
          // çµ„åˆæ›´å¤šè³‡è¨Š
          const codePoint = char.codePointAt(0).toString(16).toUpperCase();
          data.push({
            index,
            filename,
            char,
            unicode: `U+${codePoint}`,
            block: getUnicodeBlock(char.codePointAt(0))
          });
        } else {
          missing.push(filename);
        }
      });

      // æª¢æŸ¥é‡è¤‡å’Œéºæ¼
      let warningMsg = "";
      if (duplicates.length > 0) {
        warningMsg += `âš ï¸ ${duplicates.length} å€‹é‡è¤‡å­—å…ƒï¼š\n${duplicates.slice(0, 10).join("\n")}${duplicates.length > 10 ? "\n..." : ""}`;
      }
      
      if (missing.length > 0) {
        if (warningMsg) warningMsg += "\n\n";
        warningMsg += `âš ï¸ ${missing.length} å€‹æœªå¡«å­—å…ƒï¼š\n${missing.slice(0, 10).join("\n")}${missing.length > 10 ? "\n..." : ""}`;
      }
      
      if (warningMsg) {
        const proceed = confirm(warningMsg + "\n\næ˜¯å¦ç¹¼çºŒåŒ¯å‡ºï¼Ÿ");
        if (!proceed) return;
      }

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `å­—åœ–å°æ‡‰_${new Date().toISOString().slice(0, 10)}.json`;
      a.click();
      
      document.getElementById("statusMessage").textContent = `ğŸ’¾ å·²åŒ¯å‡º ${data.length} å€‹å­—å…ƒå°æ‡‰ï¼ˆå…± ${images.length} å€‹åœ–ç‰‡ï¼‰`;
    }

    function getUnicodeBlock(codePoint) {
      if (codePoint >= 0x4E00 && codePoint <= 0x9FFF) return "CJK çµ±ä¸€è¡¨æ„æ–‡å­—åŸºæœ¬å€";
      if (codePoint >= 0x3400 && codePoint <= 0x4DBF) return "CJK çµ±ä¸€è¡¨æ„æ–‡å­—æ“´å……å€ A";
      if (codePoint >= 0x20000 && codePoint <= 0x2A6DF) return "CJK çµ±ä¸€è¡¨æ„æ–‡å­—æ“´å……å€ B";
      if (codePoint >= 0x2A700 && codePoint <= 0x2B73F) return "CJK çµ±ä¸€è¡¨æ„æ–‡å­—æ“´å……å€ C";
      if (codePoint >= 0x2B740 && codePoint <= 0x2B81F) return "CJK çµ±ä¸€è¡¨æ„æ–‡å­—æ“´å……å€ D";
      if (codePoint >= 0x2B820 && codePoint <= 0x2CEAF) return "CJK çµ±ä¸€è¡¨æ„æ–‡å­—æ“´å……å€ E";
      if (codePoint >= 0x2CEB0 && codePoint <= 0x2EBEF) return "CJK çµ±ä¸€è¡¨æ„æ–‡å­—æ“´å……å€ F";
      if (codePoint >= 0x30000 && codePoint <= 0x3134F) return "CJK çµ±ä¸€è¡¨æ„æ–‡å­—æ“´å……å€ G";
      if (codePoint >= 0x31350 && codePoint <= 0x323AF) return "CJK çµ±ä¸€è¡¨æ„æ–‡å­—æ“´å……å€ H";
      // å…¶ä»–å¸¸ç”¨å€å¡Š
      if (codePoint >= 0x2E80 && codePoint <= 0x2EFF) return "CJK éƒ¨é¦–è£œå……";
      if (codePoint >= 0x2F00 && codePoint <= 0x2FDF) return "åº·ç†™éƒ¨é¦–";
      if (codePoint >= 0x3000 && codePoint <= 0x303F) return "CJK ç¬¦è™Ÿå’Œæ¨™é»";
      return "å…¶ä»–å€å¡Š";
    }

    function filterGrid() {
      const searchTerm = document.getElementById("searchBox").value.toLowerCase();
      
      if (!searchTerm) {
        filteredImages = [...images];
      } else {
        filteredImages = images.filter(file => {
          return file.name.toLowerCase().includes(searchTerm);
        });
      }
      
      renderPagination();
      renderPage(1);
    }

    function adjustZoom(zoomLevel) {
      document.documentElement.style.setProperty('--image-scale', `${zoomLevel}%`);
      document.getElementById("zoomValue").textContent = `${zoomLevel}%`;
      
      const imageStyle = document.createElement('style');
      imageStyle.textContent = `.cell img { max-width: ${zoomLevel}%; }`;
      
      // ç§»é™¤èˆŠçš„æ¨£å¼æ¨™ç±¤ï¼ˆå¦‚æœæœ‰ï¼‰
      const oldStyle = document.getElementById('dynamic-image-style');
      if (oldStyle) oldStyle.remove();
      
      // æ·»åŠ æ–°çš„æ¨£å¼æ¨™ç±¤
      imageStyle.id = 'dynamic-image-style';
      document.head.appendChild(imageStyle);
    }

    function saveProgress() {
      const inputs = document.querySelectorAll("input[data-index]");
      const data = {};
      
      inputs.forEach(input => {
        if (input.value) {
          data[input.dataset.filename] = input.value;
        }
      });
      
      if (Object.keys(data).length === 0) {
        alert("âš ï¸ æ²’æœ‰è³‡æ–™å¯å„²å­˜ï¼");
        return;
      }
      
      localStorage.setItem('fontEditorProgress', JSON.stringify(data));
      const timestamp = new Date().toLocaleString();
      document.getElementById("statusMessage").textContent = `ğŸ’¾ é€²åº¦å·²æš«å­˜æ–¼ç€è¦½å™¨ï¼ˆ${Object.keys(data).length} å€‹å­—å…ƒï¼Œ${timestamp}ï¼‰`;
    }

    function loadProgress() {
      const savedData = localStorage.getItem('fontEditorProgress');
      if (!savedData) {
        alert("âš ï¸ æ‰¾ä¸åˆ°å·²å„²å­˜çš„é€²åº¦ï¼");
        return;
      }
      
      try {
        const data = JSON.parse(savedData);
        const inputs = document.querySelectorAll("input[data-index]");
        let loadedCount = 0;
        
        inputs.forEach(input => {
          const filename = input.dataset.filename;
          if (data[filename]) {
            input.value = data[filename];
            validateAndUpdateInfo(input);
            loadedCount++;
          }
        });
        
        document.getElementById("statusMessage").textContent = `âœ… å·²è¼‰å…¥ ${loadedCount} å€‹å­—å…ƒè³‡æ–™`;
      } catch (e) {
        alert("âš ï¸ è¼‰å…¥é€²åº¦æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼");
        console.error(e);
      }
    }
  </script>
</body>
</html>
